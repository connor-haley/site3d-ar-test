"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const x=require("react/jsx-runtime"),h=require("@react-three/fiber"),w=require("@react-three/postprocessing"),L=require("postprocessing"),e=require("react"),C=require("three"),a=require("./shared.cjs"),j=require("@takram/three-geospatial"),A=require("@react-three/drei"),R=e.createContext({}),b=e.forwardRef(function({textures:t,useHalfFloat:r,ellipsoid:l=j.Ellipsoid.WGS84,correctAltitude:n=!0,photometric:s=!0,date:u,children:i},f){const o=e.useRef({sunDirection:new C.Vector3,moonDirection:new C.Vector3,rotationMatrix:new C.Matrix4}),g=h.useThree(({gl:D})=>D);r==null&&(r=g.getContext().getExtension("OES_texture_float_linear")==null);const[m,p]=e.useState(typeof t!="string"?t:void 0);e.useEffect(()=>{if(typeof t=="string"){const D=new a.PrecomputedTexturesLoader;D.useHalfFloat=r,(async()=>{p(await D.loadAsync(t))})().catch(v=>{console.error(v)})}else t!=null?p(t):p(void 0)},[t,r]);const c=e.useMemo(()=>({textures:m,useHalfFloat:r,ellipsoid:l,correctAltitude:n,photometric:s,transientProps:o.current}),[m,r,l,n,s]),y=e.useMemo(()=>{const{sunDirection:D,moonDirection:v,rotationMatrix:S}=o.current;return P=>{a.getECIToECEFRotationMatrix(P,S),a.getSunDirectionECI(P,D).applyMatrix4(S),a.getMoonDirectionECI(P,v).applyMatrix4(S)}},[]),E=u!=null&&!isNaN(+u)?+u:void 0;return e.useEffect(()=>{E!=null&&y(E)},[E,y]),e.useImperativeHandle(f,()=>({...o.current,textures:m,updateByDate:y}),[m,y]),x.jsx(R.Provider,{value:c,children:i})});function M(d){const{irradianceTexture:t,scatteringTexture:r,transmittanceTexture:l,useHalfFloat:n,ellipsoid:s,correctAltitude:u,photometric:i,sunDirection:f,sunAngularRadius:o,renderTargetCount:g,...m}=d;return[{irradianceTexture:t,scatteringTexture:r,transmittanceTexture:l,useHalfFloat:n,ellipsoid:s,correctAltitude:u,photometric:i,sunDirection:f,sunAngularRadius:o,renderTargetCount:g},m]}const k=e.forwardRef(function(t,r){const{textures:l,transientProps:n,...s}=e.useContext(R),[u,{blendFunction:i,...f}]=M({...a.aerialPerspectiveEffectOptionsDefaults,...s,...l,...t}),o=e.useContext(w.EffectComposerContext),{normalPass:g,camera:m}=o,p="geometryPass"in o&&o.geometryPass instanceof L.RenderPass&&"geometryTexture"in o.geometryPass&&o.geometryPass.geometryTexture instanceof C.Texture?o.geometryPass.geometryTexture:void 0,c=e.useMemo(()=>new a.AerialPerspectiveEffect(void 0,{blendFunction:i}),[i]);return e.useEffect(()=>()=>{c.dispose()},[c]),h.useFrame(()=>{n!=null&&(c.sunDirection.copy(n.sunDirection),c.moonDirection.copy(n.moonDirection))}),x.jsx("primitive",{ref:r,object:c,mainCamera:m,normalBuffer:p??(g==null?void 0:g.texture)??null,...u,...f,octEncodedNormal:p!=null})}),_=e.forwardRef(function(t,r){const{textures:l,transientProps:n,...s}=e.useContext(R),[u,{sun:i,moon:f,moonDirection:o,moonAngularRadius:g,lunarRadianceScale:m,...p}]=M({...a.skyMaterialParametersDefaults,...s,...l,...t}),c=e.useMemo(()=>new a.SkyMaterial,[]);return e.useEffect(()=>()=>{c.dispose()},[c]),h.useFrame(()=>{n!=null&&(c.sunDirection.copy(n.sunDirection),c.moonDirection.copy(n.moonDirection))}),x.jsx(A.ScreenQuad,{renderOrder:a.SKY_RENDER_ORDER,...p,ref:r,children:x.jsx("primitive",{object:c,...u,sun:i,moon:f,moonDirection:o,moonAngularRadius:g,lunarRadianceScale:m})})});function T(d){return t=>{d.forEach(r=>{typeof r=="function"?r(t):r!=null&&(r.current=t)})}}const q=e.forwardRef(function(t,r){const{textures:l,transientProps:n,...s}=e.useContext(R),u=e.useRef(null);return h.useFrame(()=>{const i=u.current;i!=null&&n!=null&&(i.sunDirection.copy(n.sunDirection),i.update())}),h.extend({SkyLightProbe:a.SkyLightProbe}),x.jsx("skyLightProbe",{ref:T([u,r]),...s,...l,...t})}),O=e.forwardRef(function({data:t,...r},l){const{textures:n,transientProps:s,...u}=e.useContext(R),[i,{pointSize:f,radianceScale:o,background:g,...m}]=M({...a.starsMaterialParametersDefaults,...u,...n,...r}),[p,c]=e.useState(typeof t!="string"?t:void 0);e.useEffect(()=>{if(typeof t=="string"){const S=new j.ArrayBufferLoader;(async()=>{c(await S.loadAsync(t))})().catch(P=>{console.error(P)})}else t!=null?c(t):c(void 0)},[t]);const y=e.useMemo(()=>p!=null?new a.StarsGeometry(p):void 0,[p]);e.useEffect(()=>()=>{y==null||y.dispose()},[y]);const E=e.useMemo(()=>new a.StarsMaterial,[]);e.useEffect(()=>()=>{E.dispose()},[E]);const D=e.useRef(null);h.useFrame(({camera:S})=>{var P;s!=null&&S.isPerspectiveCamera===!0&&(E.sunDirection.copy(s.sunDirection),(P=D.current)==null||P.setRotationFromMatrix(s.rotationMatrix))});const v=h.useThree(({camera:S})=>S);return y==null||v.isPerspectiveCamera!==!0?null:x.jsxs("points",{ref:T([D,l]),frustumCulled:!1,renderOrder:a.SKY_RENDER_ORDER+1,...m,children:[x.jsx("primitive",{object:y}),x.jsx("primitive",{object:E,...i,pointSize:f,radianceScale:o,background:g,depthTest:!0,depthWrite:!1})]})}),N=e.forwardRef(function({position:t,...r},l){const{textures:n,transientProps:s,...u}=e.useContext(R),i=e.useRef(null);h.useFrame(()=>{const o=i.current;o!=null&&s!=null&&(o.sunDirection.copy(s.sunDirection),o.update())});const f=e.useMemo(()=>new C.Object3D,[]);return h.extend({SunDirectionalLight:a.SunDirectionalLight}),x.jsxs(x.Fragment,{children:[x.jsx("sunDirectionalLight",{ref:T([i,l]),...u,...n,...r,target:f}),x.jsx("primitive",{object:f,position:t})]})});function F(d,t){const r=h.useThree(({gl:n})=>n);return t==null&&(t=r.getContext().getExtension("OES_texture_float_linear")==null),{textures:h.useLoader(a.PrecomputedTexturesLoader,d,n=>{n.useHalfFloat=t}),useHalfFloat:t}}exports.AerialPerspective=k;exports.Atmosphere=b;exports.AtmosphereContext=R;exports.Sky=_;exports.SkyLight=q;exports.Stars=O;exports.SunLight=N;exports.useAtmosphereTextureProps=F;
//# sourceMappingURL=r3f.cjs.map
